{% extends 'base.html' %}
{% block content %}
{% load static %}
<head>
    <title>Playground</title>
    <meta charset="UTF-8">
</head>
    <script type="text/javascript">

        var displayAudio = function() {
            var audioElem = document.getElementById("audioDiv");
            var elem = document.createElement("AUDIO");
            var x = audioElem.append(elem);
            var link = document.getElementById("audioDiv").attributes[1].value;
            document.getElementsByTagName("audio")[0].setAttribute("src","/static/music/"+ link);
            document.getElementsByTagName("audio")[0].setAttribute("controls","controls");

            document.getElementById("nextButton").style.display = "none";
            document.getElementById("voteButton").style.display = "block";

        }

        $(document).on('ready', function () {
            displayAudio();
        });


        var votes = function () {
            var votesInput = {};
            var answer;
            var votes = document.getElementsByClassName("participant-dropdown-list");
            for (var i = 0; i < votes.length; i++) {
                votesInput[votes[i][i + 1].innerHTML] = votes[i].value;
            }

            var audioElem = document.getElementById("audioDiv");
            if (audioElem && audioElem.attributes) {
                answer = audioElem.attributes[2].value;
            }

            var gameId = parseInt(document.URL.split("randomise/")[1].split("/")[0]);

            var url = document.URL.split("randomise");
            $.post(url[0] + "vote/", {
                "game": gameId,
                "votes": JSON.stringify(votesInput),
                "answer": answer
            }, function (response) {
                document.getElementById("correctAnswerSpan").innerHTML = "Answer : " + answer;
                var playerDom = document.getElementsByClassName("player-name");
                var scoreDom = document.getElementsByClassName("player-score");

                for (var i = 0; i < playerDom.length; i++) {
                    scoreDom[i].innerHTML = response[playerDom[i].innerHTML];
                }

                document.getElementById("voteButton").style.display = "none";
                document.getElementById("nextButton").style.display = "block";


            });
        }

        var next = function () {

            $('.participant-dropdown-list').prop('selectedIndex', 0);

            document.getElementById("correctAnswerSpan").innerHTML = "";
            document.getElementById("audioDiv").remove();
            if (document.getElementById("audioDiv")) {
                displayAudio();

                document.getElementById("voteButton").style.display = "block";
                document.getElementById("nextButton").style.display = "none";

            } else {
                var para = document.createElement("P");
                para.innerHTML = "Game Over !!";
                document.getElementById("audioContainer").appendChild(para);

                document.getElementById("nextButton").style.display = "none";
                document.getElementById("voteButton").style.display = "none";

                var url = document.URL.split("randomise");
                var gameId = parseInt(document.URL.split("randomise/")[1].split("/")[0]);

                $.post(url[0] + "end_game/", {"game" : gameId}, function (res) {
                    var msgText;
                    if(res && res.message.length > 1) {
                        msgText = "The Winners are "
                    } else {
                        msgText = "The Winner is "
                    }

                    document.getElementById("winner").innerHTML = msgText + res.message.toString() + " !!";
                })
            }

        }


    </script>

    <div class="main-container">
        <div id="audioContainer" class="app-text-play" style="margin-top:4rem">
            {% for item in context %}

            <div id="audioDiv" link = {{ item.link }} value = {{ item.name }}></div>

            {% endfor %}
            <div style="margin-top: 4rem;display:flex;justify-content: center" class="app-text-play" id="correctAnswerSpan">
            </div>

        </div>
        <div class="app-text-play">
            <h1 class="app-text-play" style="font-size: 50px; margin-bottom: 20px">Voting</h1>
            <div class="app-votings-section">
                <table class="app-text-play voting-line-break" style="width: 100%">
                    <tr style="display: flex;justify-content: space-between;margin-bottom: 1rem;margin-top: 1rem">
                        <th>Player's Name</th>
                        <th>Vote</th>
                    </tr>
                    {% for item in uniquePlayers %}
                    <tr style="display: flex;justify-content: space-between;margin-bottom: 1rem;margin-top: 1rem">
                        <td>
                            {{ item}} :
                        </td>
                        <td>
                            <select name="selections" class="participant-dropdown-list">
                                <option>-------------</option>
                                {% for player in uniquePlayers %}
                                <option>{{player}}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    {% endfor %}
                </table>

                <button class="btn btn-primary" id="voteButton" onclick="votes()" style="margin-top: 15px;">Vote</button>
                <button class="btn btn-primary" id="nextButton" onclick="next()" style="margin-top: 15px; margin-left: 4rem;">Next</button>
            </div>

        </div>
        <div class="app-text-play">
            <h1 class="app-text-play" style="font-size: 50px; margin-bottom: 20px">Scores</h1>
            <div id="scoreboard" class="app-text-play">
                <table style="width: 100%" class="voting-line-break">
                    <tr style="display: flex;justify-content: space-between;margin-bottom: 1rem;margin-top: 1rem">
                        <th>Player's Name</th>
                        <th style="padding-left: 4rem;">Score</th>
                    </tr>

                    {% for key, value in scorecard.items %}
                    <tr style="display: flex;justify-content: space-between;margin-bottom: 1rem;margin-top: 1rem">
                        <td class="player-name">{{ key }}</td>
                        <td class="player-score" style="padding-left: 4rem;">{{ value }}</td>
                    </tr>
                    {% endfor %}

                </table>
            </div>

        </div>
    </div>
    
    <div id="winner" style="text-align: center; margin-top: 2rem;" class="app-text-play">

    </div>

{% endblock %}
